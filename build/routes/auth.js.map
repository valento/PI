{"version":3,"sources":["../../server/routes/auth.js"],"names":["authRouter","express","Router","mergeParams","use","bodyParser","json","post","req","res","next","new_user","user","username","token","confirmToken","pass","email","body","credentials","tester","split","t","rest","join","jwtOptions","expiresIn","scope","api","checkOne","then","results","length","uid","jwt","sign","process","env","JWT_SECRET","getOne","status","error","message","userlast","verified","orders","credit","gender","bday","membership","language","Object","assign","locations","forEach","mobile","ent","name","location","city","admin","door","floor","bell","id","entry","prime","c_status","push","err","generator","generate","numbers","u","bcrypt","hash","signup","password","console","log","catch","get","getUser","params","decoded","decode","errr","redirect","verify","rows"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;AACA;;;;;;;;AAEA,IAAIA,aAAaC,kBAAQC,MAAR,CAAe;AAC9BC,eAAa;AADiB,CAAf,CAAjB;;AAIAH,WAAWI,GAAX,CAAeC,qBAAWC,IAAX,EAAf;;AAEAN,WAAWO,IAAX,CAAgB,GAAhB,EAAqB,UAACC,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAkB;AACrC,MAAIC,WAAW,IAAf;AAAA,MAAqBC,aAArB;AAAA,MAA2BC,iBAA3B;AAAA,MAAqCC,cAArC;AAAA,MAA4CC,qBAA5C;AAAA,MAA0DC,aAA1D;AADqC,MAE7BC,KAF6B,GAEnBT,IAAIU,IAAJ,CAASC,WAFU,CAE7BF,KAF6B;;AAGrC,MAAMG,SAASH,MAAMI,KAAN,CAAY,GAAZ,EAAiB,CAAjB,MAAsB,QAAtB,GAAiC,IAAjC,GAAwC,KAAvD;;AAHqC,6BAIfJ,MAAMI,KAAN,CAAY,GAAZ,EAAiB,CAAjB,EAAoBA,KAApB,CAA0B,GAA1B,CAJe;AAAA;AAAA,MAI7BC,CAJ6B;AAAA,MAIxBC,IAJwB;;AAKrC,MAAGH,MAAH,EAAW;AAAEP,eAAWU,KAAKC,IAAL,CAAU,GAAV,CAAX;AAA2B;AACxC,MAAMC,aAAa,EAAEC,WAAW,MAAb,EAAnB;AACA,MAAMC,QAAQ,CACZ,UADY,EACD,UADC,EACU,KADV,EACgB,UADhB,EAC2B,QAD3B,EACoC,QADpC,EAEZ,QAFY,EAEH,MAFG,EAEI,YAFJ,EAEiB,UAFjB,EAE4B,QAF5B,CAAd;AAIAC,iBAAIC,QAAJ,CAAcZ,KAAd,EAAoBU,KAApB,EAA4BG,IAA5B,CAAkC,mBAAW;AAC/C;AACI,QAAGC,QAAQC,MAAR,GAAiB,CAApB,EAAsB;AAAA,UACZC,GADY,GACJF,QAAQ,CAAR,CADI,CACZE,GADY;;AAEpBnB,cAAQoB,uBAAIC,IAAJ,CAAS,EAAClB,OAAMA,KAAP,EAAagB,KAAIA,GAAjB,EAAT,EAA+BG,QAAQC,GAAR,CAAYC,UAA3C,EAAsDb,UAAtD,CAAR;AACA;;AAEA,UAAI;AACFG,uBAAIW,MAAJ,CAAW,EAAEtB,OAAOA,KAAT,EAAX,EAA4B,MAA5B,EAAmCU,KAAnC,EACCG,IADD,CACO,mBAAW;AAChB,cAAGC,QAAQC,MAAR,KAAmB,CAAtB,EAAyB,OAAOvB,IAAI+B,MAAJ,CAAW,GAAX,EAAgBlC,IAAhB,CAAqB,EAACmC,OAAO,EAACC,SAAS,gBAAV,EAAR,EAArB,CAAP;;AAEzB;;AAHgB,0BAOZX,QAAQ,CAAR,CAPY;AAAA,cAKdE,GALc,aAKdA,GALc;AAAA,cAKVpB,QALU,aAKVA,QALU;AAAA,cAKD8B,QALC,aAKDA,QALC;AAAA,cAKQC,QALR,aAKQA,QALR;AAAA,cAKiBC,MALjB,aAKiBA,MALjB;AAAA,cAKwBC,MALxB,aAKwBA,MALxB;AAAA,cAMdC,MANc,aAMdA,MANc;AAAA,cAMPC,IANO,aAMPA,IANO;AAAA,cAMFC,UANE,aAMFA,UANE;AAAA,cAMSC,QANT,aAMSA,QANT;AAAA,cAMkBV,MANlB,aAMkBA,MANlB;AAAA,cAM4BjB,IAN5B;;AAShBX,iBAAOuC,OAAOC,MAAP,CAAc,EAAd,EAAiB,EAACtC,OAAOA,KAAR,EAAeH,UAAU,KAAzB,EAAjB,EAAiD;AACtDsB,oBADsD,EAClDpB,kBADkD,EACzC8B,kBADyC,EAChCC,kBADgC,EACvBC,cADuB,EAChBC,cADgB;AAEtDC,0BAFsD,EAE/CC,UAF+C,EAE1CC,sBAF0C,EAE/BC,kBAF+B,EAEtBV;AAFsB,WAAjD,CAAP;;AAKA,cAAGT,QAAQC,MAAR,GAAiB,CAApB,EAAsB;AACpBpB,iBAAKyC,SAAL,GAAgB,EAAhB;AACAtB,oBAAQuB,OAAR,CAAiB,eAAO;AAAA,kBACfC,MADe,GAC4DC,GAD5D,CACfD,MADe;AAAA,kBACRE,IADQ,GAC4DD,GAD5D,CACRC,IADQ;AAAA,kBACHC,QADG,GAC4DF,GAD5D,CACHE,QADG;AAAA,kBACMC,IADN,GAC4DH,GAD5D,CACMG,IADN;AAAA,kBACWC,KADX,GAC4DJ,GAD5D,CACWI,KADX;AAAA,kBACiBC,IADjB,GAC4DL,GAD5D,CACiBK,IADjB;AAAA,kBACsBC,KADtB,GAC4DN,GAD5D,CACsBM,KADtB;AAAA,kBAC4BC,IAD5B,GAC4DP,GAD5D,CAC4BO,IAD5B;AAAA,kBACiCC,EADjC,GAC4DR,GAD5D,CACiCQ,EADjC;AAAA,kBACoCC,KADpC,GAC4DT,GAD5D,CACoCS,KADpC;AAAA,kBAC0CC,KAD1C,GAC4DV,GAD5D,CAC0CU,KAD1C;AAAA,kBACgDC,QADhD,GAC4DX,GAD5D,CACgDW,QADhD;;AAEtB,kBAAGA,aAAa,CAAhB,EAAkB;AAChBvD,qBAAKyC,SAAL,CAAee,IAAf,CAAoB,EAACb,cAAD,EAAQE,UAAR,EAAaC,kBAAb,EAAsBC,UAAtB,EAA2BC,YAA3B,EAAiCC,UAAjC,EAAsCC,YAAtC,EAA4CC,UAA5C,EAAiDC,MAAjD,EAAoDC,YAApD,EAA0DC,YAA1D,EAApB;AACA;AACH,aALD;AAMD,WARD,MAQO;AACL,gBAAI3C,KAAKyC,EAAL,KAAY,IAAhB,EAAsB;AACpBpD,mBAAKyC,SAAL,GAAgB,EAAhB;AACAzC,mBAAKyC,SAAL,CAAee,IAAf,CAAoB7C,IAApB;AACD;AACF;AACDd,cAAI+B,MAAJ,CAAW,GAAX,EAAgBlC,IAAhB,CAAqB,EAACM,UAAD,EAArB;AACD,SA9BD;AA+BD,OAhCD,CAgCE,OAAMyD,GAAN,EAAW;AACX5D,YAAI+B,MAAJ,CAAW,GAAX,EAAgBlC,IAAhB,CAAqB,EAAEmC,OAAO,EAAEC,SAAS2B,GAAX,EAAT,EAArB;AACD;AACF;AACL;AAzCI,SA0CK;AACT;AACMtD,uBAAemB,uBAAIC,IAAJ,CAAS,EAAElB,YAAF,EAAT,EAAmBmB,QAAQC,GAAR,CAAYC,UAA/B,EAA0Cb,UAA1C,CAAf;AACAT,eAAOsD,2BAAUC,QAAV,CAAmB;AACxBvC,kBAAQ,CADgB;AAExBwC,mBAAS;AAFe,SAAnB,CAAP;AAIA,YAAIC,IAAIrD,SAAS,EAACP,UAAUU,KAAKC,IAAL,CAAU,GAAV,CAAX,EAA0ByB,YAAY,EAAtC,EAAT,GAAqD,EAA7D;AACN;AACMyB,yBAAOC,IAAP,CAAY3D,IAAZ,EAAkB,CAAlB,EAAqB,UAACqD,GAAD,EAAKM,IAAL,EAAc;AACjC,cAAG,CAACN,GAAJ,EAAQ;AACN,gBAAI;AACFzC,6BAAIgD,MAAJ,CAAWzB,OAAOC,MAAP,CAAc,EAACnC,OAAMA,KAAP,EAAa4D,UAASF,IAAtB,EAA2B7D,OAAMC,YAAjC,EAAd,EAA6D0D,CAA7D,CAAX,EACC3C,IADD,CACO,cAAM;AACvB;AACY,6CAAgBb,KAAhB,EAAsBF,YAAtB;AACA+D,wBAAQC,GAAR,CAAY,aAAZ,EAA0Bf,EAA1B;AACZ;AACYlD,wBAAQoB,uBAAIC,IAAJ,CAAS,EAAClB,OAAMA,KAAP,EAAagB,KAAI+B,EAAjB,EAAT,EAA8B5B,QAAQC,GAAR,CAAYC,UAA1C,EAAqDb,UAArD,CAAR;AACA,oBAAI;AACFG,iCAAIW,MAAJ,CAAW,EAAEtB,OAAOA,KAAT,EAAX,EAA4B,MAA5B,EAAmCU,KAAnC,EACCG,IADD,CACO,mBAAW;AAChB,wBAAGC,QAAQC,MAAR,KAAmB,CAAtB,EAAyB,OAAOvB,IAAI+B,MAAJ,CAAW,GAAX,EAAgBlC,IAAhB,CAAqB,EAACmC,OAAO,EAACC,SAAS,gBAAV,EAAR,EAArB,CAAP;;AADT,qCAKZX,QAAQ,CAAR,CALY;AAAA,wBAGdE,GAHc,cAGdA,GAHc;AAAA,wBAGVpB,QAHU,cAGVA,QAHU;AAAA,wBAGD8B,QAHC,cAGDA,QAHC;AAAA,wBAGQC,QAHR,cAGQA,QAHR;AAAA,wBAGiBC,MAHjB,cAGiBA,MAHjB;AAAA,wBAGwBC,MAHxB,cAGwBA,MAHxB;AAAA,wBAIdC,MAJc,cAIdA,MAJc;AAAA,wBAIPC,IAJO,cAIPA,IAJO;AAAA,wBAIFC,UAJE,cAIFA,UAJE;AAAA,wBAISC,QAJT,cAISA,QAJT;AAAA,wBAIkBV,MAJlB,cAIkBA,MAJlB;AAAA,wBAI4BjB,IAJ5B;;AAOhBX,2BAAOuC,OAAOC,MAAP,CAAc,EAAd,EAAiB,EAACtC,OAAOA,KAAR,EAAeH,UAAU,IAAzB,EAAjB,EAAgD;AACrDsB,8BADqD,EACjDpB,kBADiD,EACxC8B,kBADwC,EAC/BC,kBAD+B,EACtBC,cADsB,EACfC,cADe;AAErDC,oCAFqD,EAE9CC,UAF8C,EAEzCC,sBAFyC,EAE9BC,kBAF8B,EAErBV;AAFqB,qBAAhD,CAAP;;AAKA/B,wBAAI+B,MAAJ,CAAW,GAAX,EAAgBlC,IAAhB,CAAqB,EAACM,UAAD,EAArB;AACD,mBAdD;AAeD,iBAhBD,CAgBE,OAAMyD,GAAN,EAAW;AACX5D,sBAAI+B,MAAJ,CAAW,GAAX,EAAgBlC,IAAhB,CAAqB,EAAEmC,OAAO,EAAEC,SAAS2B,GAAX,EAAT,EAArB;AACD;AAEF,eA3BD;AA4BD,aA7BD,CA6BE,OAAMA,GAAN,EAAW;AACX5D,kBAAI+B,MAAJ,CAAW,GAAX,EAAgBlC,IAAhB,CAAqB,EAAEmC,OAAO,EAAEC,SAAS2B,GAAX,EAAT,EAArB;AACD;AACJ;AAAC,SAlCF;AAmCD;AACF,GAzFD,EA0FCW,KA1FD,CA0FQ;AAAA,WAAOvE,IAAI+B,MAAJ,CAAW,GAAX,EAAgBlC,IAAhB,CAAqB+D,GAArB,CAAP;AAAA,GA1FR;AA2FD,CAtGD;;AAwGA;AACArE,WAAWiF,GAAX,CAAe,QAAf,EAAyBC,mBAAzB,EAAkC,UAAC1E,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAkB;AAAA,MAC1CuB,GAD0C,GAC5BzB,GAD4B,CAC1CyB,GAD0C;AAAA,MACtChB,KADsC,GAC5BT,GAD4B,CACtCS,KADsC;;AAElDW,iBAAIC,QAAJ,CAAaZ,KAAb,EAAoBa,IAApB,CAA0B,mBAAW;AACnC,QAAGC,QAAQC,MAAR,GAAe,CAAlB,EAAoB;AAClBvB,UAAI+B,MAAJ,CAAW,GAAX,EAAgBlC,IAAhB,CAAqByB,OAArB;AACD,KAFD,MAEO;AACLtB,UAAI+B,MAAJ,CAAW,GAAX,EAAgBlC,IAAhB,CAAqB,EAACmC,OAAO,EAACC,SAAS,cAAV,EAAR,EAArB;AACD;AACF,GAND;AAOD,CATD;;AAWA1C,WAAWiF,GAAX,CAAe,sBAAf,EAAuC,UAACzE,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAkB;AAAA,MAC/CI,KAD+C,GACrCN,IAAI2E,MADiC,CAC/CrE,KAD+C;;AAEvD,MAAMsE,UAAUlD,uBAAImD,MAAJ,CAAWvE,KAAX,CAAhB;AACA,MAAI,CAACsE,OAAD,IAAYA,YAAY,IAA5B,EAAmC;AACjCN,YAAQC,GAAR,CAAY,+BAAZ;AACAvE,QAAI8E,IAAJ,GAAW,EAAE5C,SAAS;AACtB;AADW,KAAX,CAEAjC,IAAI8E,QAAJ,CAAa,GAAb;AACD,GALD,MAKO;AACL3D,mBAAI4D,MAAJ,CAAWJ,QAAQnE,KAAnB,EAAyB,CAAC,OAAD,CAAzB,EAAoCa,IAApC,CAA0C,gBAAQ;AAChD,UAAG2D,SAAS,CAAZ,EAAe;AACbjF,YAAI8E,IAAJ,GAAW,EAAC5C,SAAS,cAAV,EAAX;AACD;AACH;AACAjC,UAAI8E,QAAJ,CAAa,GAAb;AACC,KAND,EAOCP,KAPD,CAOQ;AAAA,aAAQ,EAACtC,SAAS,sBAAV,EAAR;AAAA,KAPR;AAQD;AACF,CAlBD;;kBAoBe1C,U","file":"auth.js","sourcesContent":["import express from 'express'\nimport bcrypt from 'bcrypt'\nimport generator from 'generate-password'\nimport jwt from 'jsonwebtoken'\nimport bodyParser from 'body-parser'\nimport api from '../api/user'\nimport { sendConfirmMail } from '../mailer'\nimport { getUser } from '../middleware/'\n\nlet authRouter = express.Router({\n  mergeParams: true\n})\n\nauthRouter.use(bodyParser.json())\n\nauthRouter.post('/', (req,res,next) => {\n  let new_user = true, user, username, token, confirmToken, pass\n  const { email } = req.body.credentials\n  const tester = email.split('.')[0]==='tester' ? true : false\n  const [ t,...rest ] = email.split('@')[0].split('.')\n  if(tester) { username = rest.join('.') }\n  const jwtOptions = { expiresIn: '240d' }\n  const scope = [\n    'username','userlast','uid','verified','orders','credit',\n    'gender','bday','membership','language','status'\n  ]\n  api.checkOne( email,scope ).then( results => {\n// --- Login -> User exist but No token: ---\n    if(results.length > 0){\n      const { uid } = results[0]\n      token = jwt.sign({email:email,uid:uid},process.env.JWT_SECRET,jwtOptions)\n      //user = Object.assign({},{token: token, new_user: false},results[0])\n\n      try {\n        api.getOne({ email: email },'user',scope)\n        .then( results => {\n          if(results.length === 0) return res.status(401).json({error: {message: 'User Not Found'}})\n\n          //let user = {}\n          const {\n            uid,username,userlast,verified,orders,credit,\n            gender,bday,membership,language,status,...rest\n          } = results[0]\n\n          user = Object.assign({},{token: token, new_user: false},{\n            uid,username,userlast,verified,orders,credit,\n            gender,bday,membership,language,status\n          })\n\n          if(results.length > 1){\n            user.locations =[]\n            results.forEach( ent => {\n              const {mobile,name,location,city,admin,door,floor,bell,id,entry,prime,c_status} = ent\n              if(c_status === 4){\n                user.locations.push({mobile,name,location,city,admin,door,floor,bell,id,entry,prime}\n              )}\n            })\n          } else {\n            if( rest.id !== null ){\n              user.locations =[]\n              user.locations.push(rest)\n            }\n          }\n          res.status(200).json({user})\n        })\n      } catch(err) {\n        res.status(500).json({ error: { message: err }})\n      }\n    }\n// --- SignUp -> New User: ---\n    else {\n// Generate Pass and Confirmation Token:\n      confirmToken = jwt.sign({ email },process.env.JWT_SECRET,jwtOptions)\n      pass = generator.generate({\n        length: 8,\n        numbers: true\n      })\n      let u = tester ? {username: rest.join('.'),membership: 64} : {}\n// encrypt password and save it to DB:\n      bcrypt.hash(pass, 8, (err,hash) => {\n        if(!err){\n          try {\n            api.signup(Object.assign({email:email,password:hash,token:confirmToken},u))\n            .then( id => {\n  // Send mail to User with confirmToken:\n              sendConfirmMail(email,confirmToken)\n              console.log('authRouter:',id)\n  // Generate Access User Token for localStorage:\n              token = jwt.sign({email:email,uid:id},process.env.JWT_SECRET,jwtOptions)\n              try {\n                api.getOne({ email: email },'user',scope)\n                .then( results => {\n                  if(results.length === 0) return res.status(401).json({error: {message: 'User Not Found'}})\n                  const {\n                    uid,username,userlast,verified,orders,credit,\n                    gender,bday,membership,language,status,...rest\n                  } = results[0]\n\n                  user = Object.assign({},{token: token, new_user: true},{\n                    uid,username,userlast,verified,orders,credit,\n                    gender,bday,membership,language,status\n                  })\n\n                  res.status(200).json({user})\n                })\n              } catch(err) {\n                res.status(500).json({ error: { message: err }})\n              }\n\n            })\n          } catch(err) {\n            res.status(500).json({ error: { message: err }})\n          }\n      }})\n    }\n  })\n  .catch( err => res.status(500).json(err) )\n})\n\n// Check if User UID Exist and STATUS:4:\nauthRouter.get('/check', getUser, (req,res,next) => {\n  const { uid,email } = req\n  api.checkOne(email).then( results => {\n    if(results.length>0){\n      res.status(200).json(results)\n    } else {\n      res.status(401).json({error: {message: 'No such User'}})\n    }\n  })\n})\n\nauthRouter.get('/confirmation/:token', (req,res,next) => {\n  const { token } = req.params\n  const decoded = jwt.decode(token)\n  if( !decoded || decoded === null ) {\n    console.log('Invalid verification token...')\n    req.errr = { message: 'Invalid verification token...'}\n    //next()\n    res.redirect('/')\n  } else {\n    api.verify(decoded.email,['email']).then( rows => {\n      if(rows === 0) {\n        req.errr = {message: 'No such user'}\n      }\n    //next()\n    res.redirect('/')\n    })\n    .catch( err => ({message: 'Something went wrong'}) )\n  }\n})\n\nexport default authRouter\n"]}