{"version":3,"sources":["../../server/routes/auth.js"],"names":["authRouter","express","Router","mergeParams","use","bodyParser","json","post","req","res","next","new_user","user","token","confirmToken","pass","email","body","credentials","jwtOptions","expiresIn","scope","api","checkOne","then","results","length","uid","jwt","sign","process","env","JWT_SECRET","getOne","status","error","message","username","userlast","verified","orders","credit","gender","bday","membership","language","rest","Object","assign","locations","forEach","mobile","ent","name","location","city","admin","door","floor","bell","id","entry","prime","c_status","push","err","generator","generate","numbers","bcrypt","hash","signup","password","console","log","catch","get","getUser","params","decoded","decode","errr","redirect","verify","rows"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;AACA;;;;;;AAEA,IAAIA,aAAaC,kBAAQC,MAAR,CAAe;AAC9BC,eAAa;AADiB,CAAf,CAAjB;;AAIAH,WAAWI,GAAX,CAAeC,qBAAWC,IAAX,EAAf;;AAEAN,WAAWO,IAAX,CAAgB,GAAhB,EAAqB,UAACC,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAkB;AACrC,MAAIC,WAAW,IAAf;AAAA,MAAqBC,aAArB;AAAA,MAA2BC,cAA3B;AAAA,MAAkCC,qBAAlC;AAAA,MAAgDC,aAAhD;AADqC,MAE7BC,KAF6B,GAEnBR,IAAIS,IAAJ,CAASC,WAFU,CAE7BF,KAF6B;;AAGrC,MAAMG,aAAa,EAAEC,WAAW,MAAb,EAAnB;AACA,MAAMC,QAAQ,CACZ,UADY,EACD,UADC,EACU,KADV,EACgB,UADhB,EAC2B,QAD3B,EACoC,QADpC,EAEZ,QAFY,EAEH,MAFG,EAEI,YAFJ,EAEiB,UAFjB,EAE4B,QAF5B,CAAd;AAIAC,iBAAIC,QAAJ,CAAcP,KAAd,EAAoBK,KAApB,EAA4BG,IAA5B,CAAkC,mBAAW;AAC/C;AACI,QAAGC,QAAQC,MAAR,GAAiB,CAApB,EAAsB;AAAA,UACZC,GADY,GACJF,QAAQ,CAAR,CADI,CACZE,GADY;;AAEpBd,cAAQe,uBAAIC,IAAJ,CAAS,EAACb,OAAMA,KAAP,EAAaW,KAAIA,GAAjB,EAAT,EAA+BG,QAAQC,GAAR,CAAYC,UAA3C,EAAsDb,UAAtD,CAAR;AACA;;AAEA,UAAI;AACFG,uBAAIW,MAAJ,CAAW,EAAEjB,OAAOA,KAAT,EAAX,EAA4B,MAA5B,EAAmCK,KAAnC,EACCG,IADD,CACO,mBAAW;AAChB,cAAGC,QAAQC,MAAR,KAAmB,CAAtB,EAAyB,OAAOjB,IAAIyB,MAAJ,CAAW,GAAX,EAAgB5B,IAAhB,CAAqB,EAAC6B,OAAO,EAACC,SAAS,gBAAV,EAAR,EAArB,CAAP;;AAEzB;;AAHgB,0BAOZX,QAAQ,CAAR,CAPY;AAAA,cAKdE,GALc,aAKdA,GALc;AAAA,cAKVU,QALU,aAKVA,QALU;AAAA,cAKDC,QALC,aAKDA,QALC;AAAA,cAKQC,QALR,aAKQA,QALR;AAAA,cAKiBC,MALjB,aAKiBA,MALjB;AAAA,cAKwBC,MALxB,aAKwBA,MALxB;AAAA,cAMdC,MANc,aAMdA,MANc;AAAA,cAMPC,IANO,aAMPA,IANO;AAAA,cAMFC,UANE,aAMFA,UANE;AAAA,cAMSC,QANT,aAMSA,QANT;AAAA,cAMkBX,MANlB,aAMkBA,MANlB;AAAA,cAM4BY,IAN5B;;AAShBlC,iBAAOmC,OAAOC,MAAP,CAAc,EAAd,EAAiB,EAACnC,OAAOA,KAAR,EAAeF,UAAU,KAAzB,EAAjB,EAAiD;AACtDgB,oBADsD,EAClDU,kBADkD,EACzCC,kBADyC,EAChCC,kBADgC,EACvBC,cADuB,EAChBC,cADgB;AAEtDC,0BAFsD,EAE/CC,UAF+C,EAE1CC,sBAF0C,EAE/BC,kBAF+B,EAEtBX;AAFsB,WAAjD,CAAP;;AAKA,cAAGT,QAAQC,MAAR,GAAiB,CAApB,EAAsB;AACpBd,iBAAKqC,SAAL,GAAgB,EAAhB;AACAxB,oBAAQyB,OAAR,CAAiB,eAAO;AAAA,kBACfC,MADe,GAC4DC,GAD5D,CACfD,MADe;AAAA,kBACRE,IADQ,GAC4DD,GAD5D,CACRC,IADQ;AAAA,kBACHC,QADG,GAC4DF,GAD5D,CACHE,QADG;AAAA,kBACMC,IADN,GAC4DH,GAD5D,CACMG,IADN;AAAA,kBACWC,KADX,GAC4DJ,GAD5D,CACWI,KADX;AAAA,kBACiBC,IADjB,GAC4DL,GAD5D,CACiBK,IADjB;AAAA,kBACsBC,KADtB,GAC4DN,GAD5D,CACsBM,KADtB;AAAA,kBAC4BC,IAD5B,GAC4DP,GAD5D,CAC4BO,IAD5B;AAAA,kBACiCC,EADjC,GAC4DR,GAD5D,CACiCQ,EADjC;AAAA,kBACoCC,KADpC,GAC4DT,GAD5D,CACoCS,KADpC;AAAA,kBAC0CC,KAD1C,GAC4DV,GAD5D,CAC0CU,KAD1C;AAAA,kBACgDC,QADhD,GAC4DX,GAD5D,CACgDW,QADhD;;AAEtB,kBAAGA,aAAa,CAAhB,EAAkB;AAChBnD,qBAAKqC,SAAL,CAAee,IAAf,CAAoB,EAACb,cAAD,EAAQE,UAAR,EAAaC,kBAAb,EAAsBC,UAAtB,EAA2BC,YAA3B,EAAiCC,UAAjC,EAAsCC,YAAtC,EAA4CC,UAA5C,EAAiDC,MAAjD,EAAoDC,YAApD,EAA0DC,YAA1D,EAApB;AACA;AACH,aALD;AAMD,WARD,MAQO;AACL,gBAAIhB,KAAKc,EAAL,KAAY,IAAhB,EAAsB;AACpBhD,mBAAKqC,SAAL,GAAgB,EAAhB;AACArC,mBAAKqC,SAAL,CAAee,IAAf,CAAoBlB,IAApB;AACD;AACF;AACDrC,cAAIyB,MAAJ,CAAW,GAAX,EAAgB5B,IAAhB,CAAqB,EAACM,UAAD,EAArB;AACD,SA9BD;AA+BD,OAhCD,CAgCE,OAAMqD,GAAN,EAAW;AACXxD,YAAIyB,MAAJ,CAAW,GAAX,EAAgB5B,IAAhB,CAAqB,EAAE6B,OAAO,EAAEC,SAAS6B,GAAX,EAAT,EAArB;AACD;AACF;AACL;AAzCI,SA0CK;AACT;AACMnD,uBAAec,uBAAIC,IAAJ,CAAS,EAAEb,YAAF,EAAT,EAAmBc,QAAQC,GAAR,CAAYC,UAA/B,EAA0Cb,UAA1C,CAAf;AACAJ,eAAOmD,2BAAUC,QAAV,CAAmB;AACxBzC,kBAAQ,CADgB;AAExB0C,mBAAS;AAFe,SAAnB,CAAP;AAIN;AACMC,yBAAOC,IAAP,CAAYvD,IAAZ,EAAkB,CAAlB,EAAqB,UAACkD,GAAD,EAAKK,IAAL,EAAc;AACjC,cAAG,CAACL,GAAJ,EAAQ;AACN,gBAAI;AACF3C,6BAAIiD,MAAJ,CAAW,EAACvD,OAAMA,KAAP,EAAawD,UAASF,IAAtB,EAA2BzD,OAAMC,YAAjC,EAAX,EACCU,IADD,CACO,cAAM;AACvB;AACY,6CAAgBR,KAAhB,EAAsBF,YAAtB;AACA2D,wBAAQC,GAAR,CAAY,aAAZ,EAA0Bd,EAA1B;AACZ;AACY/C,wBAAQe,uBAAIC,IAAJ,CAAS,EAACb,OAAMA,KAAP,EAAaW,KAAIiC,EAAjB,EAAT,EAA8B9B,QAAQC,GAAR,CAAYC,UAA1C,EAAqDb,UAArD,CAAR;AACAP,uBAAOmC,OAAOC,MAAP,CAAc,EAAd,EAAiB,EAACnC,OAAOA,KAAR,EAAeF,UAAU,IAAzB,EAAjB,CAAP;AACAF,oBAAIyB,MAAJ,CAAW,GAAX,EAAgB5B,IAAhB,CAAqB,EAACM,UAAD,EAArB;AACD,eATD;AAUD,aAXD,CAWE,OAAMqD,GAAN,EAAW;AACXxD,kBAAIyB,MAAJ,CAAW,GAAX,EAAgB5B,IAAhB,CAAqB2D,GAArB;AACD;AACJ;AAAC,SAhBF;AAiBD;AACF,GAtED,EAuECU,KAvED,CAuEQ;AAAA,WAAOlE,IAAIyB,MAAJ,CAAW,GAAX,EAAgB5B,IAAhB,CAAqB2D,GAArB,CAAP;AAAA,GAvER;AAwED,CAhFD;;AAkFA;AACAjE,WAAW4E,GAAX,CAAe,QAAf,EAAyBC,mBAAzB,EAAkC,UAACrE,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAkB;AAAA,MAC1CiB,GAD0C,GAC5BnB,GAD4B,CAC1CmB,GAD0C;AAAA,MACtCX,KADsC,GAC5BR,GAD4B,CACtCQ,KADsC;;AAElDM,iBAAIC,QAAJ,CAAaP,KAAb,EAAoBQ,IAApB,CAA0B,mBAAW;AACnC,QAAGC,QAAQC,MAAR,GAAe,CAAlB,EAAoB;AAClBjB,UAAIyB,MAAJ,CAAW,GAAX,EAAgB5B,IAAhB,CAAqBmB,OAArB;AACD,KAFD,MAEO;AACLhB,UAAIyB,MAAJ,CAAW,GAAX,EAAgB5B,IAAhB,CAAqB,EAAC6B,OAAO,EAACC,SAAS,cAAV,EAAR,EAArB;AACD;AACF,GAND;AAOD,CATD;;AAWApC,WAAW4E,GAAX,CAAe,sBAAf,EAAuC,UAACpE,GAAD,EAAKC,GAAL,EAASC,IAAT,EAAkB;AAAA,MAC/CG,KAD+C,GACrCL,IAAIsE,MADiC,CAC/CjE,KAD+C;;AAEvD,MAAMkE,UAAUnD,uBAAIoD,MAAJ,CAAWnE,KAAX,CAAhB;AACA,MAAI,CAACkE,OAAD,IAAYA,YAAY,IAA5B,EAAmC;AACjCN,YAAQC,GAAR,CAAY,+BAAZ;AACAlE,QAAIyE,IAAJ,GAAW,EAAE7C,SAAS;AACtB;AADW,KAAX,CAEA3B,IAAIyE,QAAJ,CAAa,GAAb;AACD,GALD,MAKO;AACL5D,mBAAI6D,MAAJ,CAAWJ,QAAQ/D,KAAnB,EAAyB,CAAC,OAAD,CAAzB,EAAoCQ,IAApC,CAA0C,gBAAQ;AAChD,UAAG4D,SAAS,CAAZ,EAAe;AACb5E,YAAIyE,IAAJ,GAAW,EAAC7C,SAAS,cAAV,EAAX;AACD;AACH;AACA3B,UAAIyE,QAAJ,CAAa,GAAb;AACC,KAND,EAOCP,KAPD,CAOQ;AAAA,aAAQ,EAACvC,SAAS,sBAAV,EAAR;AAAA,KAPR;AAQD;AACF,CAlBD;;kBAoBepC,U","file":"auth.js","sourcesContent":["import express from 'express'\nimport bcrypt from 'bcrypt'\nimport generator from 'generate-password'\nimport jwt from 'jsonwebtoken'\nimport bodyParser from 'body-parser'\nimport api from '../api/user'\nimport { sendConfirmMail } from '../mailer'\nimport { getUser } from '../middleware/'\n\nlet authRouter = express.Router({\n  mergeParams: true\n})\n\nauthRouter.use(bodyParser.json())\n\nauthRouter.post('/', (req,res,next) => {\n  let new_user = true, user, token, confirmToken, pass\n  const { email } = req.body.credentials\n  const jwtOptions = { expiresIn: '240d' }\n  const scope = [\n    'username','userlast','uid','verified','orders','credit',\n    'gender','bday','membership','language','status'\n  ]\n  api.checkOne( email,scope ).then( results => {\n// --- Login -> User exist but No token: ---\n    if(results.length > 0){\n      const { uid } = results[0]\n      token = jwt.sign({email:email,uid:uid},process.env.JWT_SECRET,jwtOptions)\n      //user = Object.assign({},{token: token, new_user: false},results[0])\n\n      try {\n        api.getOne({ email: email },'user',scope)\n        .then( results => {\n          if(results.length === 0) return res.status(401).json({error: {message: 'User Not Found'}})\n\n          //let user = {}\n          const {\n            uid,username,userlast,verified,orders,credit,\n            gender,bday,membership,language,status,...rest\n          } = results[0]\n\n          user = Object.assign({},{token: token, new_user: false},{\n            uid,username,userlast,verified,orders,credit,\n            gender,bday,membership,language,status\n          })\n\n          if(results.length > 1){\n            user.locations =[]\n            results.forEach( ent => {\n              const {mobile,name,location,city,admin,door,floor,bell,id,entry,prime,c_status} = ent\n              if(c_status === 4){\n                user.locations.push({mobile,name,location,city,admin,door,floor,bell,id,entry,prime}\n              )}\n            })\n          } else {\n            if( rest.id !== null ){\n              user.locations =[]\n              user.locations.push(rest)\n            }\n          }\n          res.status(200).json({user})\n        })\n      } catch(err) {\n        res.status(500).json({ error: { message: err }})\n      }\n    }\n// --- SignUp -> New User: ---\n    else {\n// Generate Pass and Confirmation Token:\n      confirmToken = jwt.sign({ email },process.env.JWT_SECRET,jwtOptions)\n      pass = generator.generate({\n        length: 8,\n        numbers: true\n      })\n// encrypt password and save it to DB:\n      bcrypt.hash(pass, 8, (err,hash) => {\n        if(!err){\n          try {\n            api.signup({email:email,password:hash,token:confirmToken})\n            .then( id => {\n  // Send mail to User with confirmToken:\n              sendConfirmMail(email,confirmToken)\n              console.log('authRouter:',id)\n  // Generate Token for localStorage:\n              token = jwt.sign({email:email,uid:id},process.env.JWT_SECRET,jwtOptions)\n              user = Object.assign({},{token: token, new_user: true})\n              res.status(200).json({user})\n            })\n          } catch(err) {\n            res.status(500).json(err)\n          }\n      }})\n    }\n  })\n  .catch( err => res.status(500).json(err) )\n})\n\n// Check if User UID Exist and STATUS:4:\nauthRouter.get('/check', getUser, (req,res,next) => {\n  const { uid,email } = req\n  api.checkOne(email).then( results => {\n    if(results.length>0){\n      res.status(200).json(results)\n    } else {\n      res.status(401).json({error: {message: 'No such User'}})\n    }\n  })\n})\n\nauthRouter.get('/confirmation/:token', (req,res,next) => {\n  const { token } = req.params\n  const decoded = jwt.decode(token)\n  if( !decoded || decoded === null ) {\n    console.log('Invalid verification token...')\n    req.errr = { message: 'Invalid verification token...'}\n    //next()\n    res.redirect('/')\n  } else {\n    api.verify(decoded.email,['email']).then( rows => {\n      if(rows === 0) {\n        req.errr = {message: 'No such user'}\n      }\n    //next()\n    res.redirect('/')\n    })\n    .catch( err => ({message: 'Something went wrong'}) )\n  }\n})\n\nexport default authRouter\n"]}