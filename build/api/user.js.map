{"version":3,"sources":["../../server/api/user.js"],"names":["config","require","dotenv","silent","options","user","get","password","database","process","env","NODE_ENV","socketPath","host","db","mysql","createConnection","signup","sql","email","data","token","console","log","Promise","resolve","reject","query","err","result","insertId","checkOne","scope","results","verify","rows","getOne","table","sc","map","entry","_key","Object","keys","_value","values","saveOne","_keys","_values","params","push","v","updateOne","id","rest","_map","getFac"],"mappings":"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","file":"user.js","sourcesContent":["import mysql from 'mysql'\nimport dotenv from 'dotenv'\n\nconst config = require('../../config')\n\ndotenv.config({silent: true})\nconst options = {\n  user: config.get('MYSQL_USER'),\n  password: config.get('MYSQL_PASSWORD'),\n  database: config.get('MYSQL_DB')\n}\n\nif( config.get('INSTANCE_CONNECTION_NAME') && process.env.NODE_ENV === 'production' ) {\n  options.socketPath = `/cloudsql/${config.get('INSTANCE_CONNECTION_NAME')}`\n} else {\n  options.host = 'localhost'\n}\n\nconst db = mysql.createConnection(options)\n\nexport default {\n\n    signup: data => {\n      let sql = ``\n      const { email,password,token } = data\n      if(email==='valentin.mundrov@gmail.com'){\n        sql = `INSERT INTO user (email,password,token,membership) VALUES('${email}','${password}','${token}',1)`\n      } else {\n        sql = `INSERT INTO user (email,password,token) VALUES('${email}','${password}','${token}');`\n      }\n      console.log('Auth Insert: ',sql)\n      return new Promise ((resolve,reject) => {\n        db.query(sql, (err,result) => {\n          if(err) {\n            console.log(err)\n            reject(err)\n          } else {\n            resolve(result.insertId)\n          }\n        })\n      })\n    },\n    checkOne: (email,scope='*') => {\n      const sql = `SELECT ${scope} FROM user WHERE email='${email}' AND c_status=4`\n      console.log('API CheckOne User: ',email)\n      return new Promise( (resolve, reject) => {\n        db.query(sql, ( err,results ) => {\n          if(!err) {\n            //if(results[0].c_status !== 4) return reject({ error: { message: 'User Account is canceled' }})\n            resolve(results)\n          } else {\n            console.log('API CheckOne User: ',err)\n            reject(err)\n          }\n        })\n      })\n    },\n    verify: email => {\n      const sql = `UPDATE user SET verified=1 WHERE email='${email}'`\n      return new Promise( (resolve, reject) => {\n        db.query(sql, ( err,rows ) => {\n          if(!err) {\n            resolve(rows)\n          } else {\n            reject(err)\n          }\n        })\n      })\n    },\n// on User.init: returns user and user's locations\n    getOne: (data={},table,scope=['*']) => {\n      let sql\n      let sc = scope.map( entry => 'u.'+entry)\n      const _key = Object.keys(data)\n      const _value = Object.values(data)\n      if(table==='user'){\n        sql = `SELECT ${sc},\n        ul.id,ul.name,ul.door,ul.floor,ul.bell,ul.admin,ul.mobile,ul.location,ul.c_status,ul.prime,\n        l.city\n        FROM user u\n        LEFT JOIN user_location ul ON u.uid=ul.uid\n        LEFT JOIN location l ON l.id=ul.location\n        WHERE u.email='${data.email}'\n        `\n      } else {\n        sql = `SELECT ${scope} FROM ${table} WHERE ${_key}='${_value}'`\n      }\n      return new Promise( (resolve,reject) => {\n        db.query(sql, (err,results) => {\n          if(!err) {\n            resolve(results)\n          } else {\n            reject(err)\n          }\n        })\n      })\n    },\n// Save user or user_location table\n    saveOne: (data={},table) => {\n      let _keys = Object.keys(data), _values = []\n      let params = Object.values(data).map( v => {\n        _values.push('?')\n        return v\n      })\n      const sql = `INSERT INTO ${table} (${_keys}) VALUES (${_values})`\n  console.log(sql,params)\n      return new Promise( (resolve,reject) => {\n        db.query(sql, params, (err,result) => {\n          if (err) return reject()\n          resolve(result.insertId)\n        })\n      })\n    },\n// Update user table or user_location table\n    updateOne: (data={},table) => {\n      const {id, ...rest} = data\n      const _map = Object.keys(rest).map( entry => {\n        if (entry==='name' || entry==='bell' || entry==='entry')\n        {\n          return `${entry}='${rest[entry]}'`\n        } else {\n          return `${entry}=${rest[entry]}`\n        }\n\n      })\n      const sql =`UPDATE ${table} SET ${_map} WHERE id=${id}`\n      console.log('ORM: ',sql)\n      return new Promise( (resolve,reject) => {\n        db.query(sql, err => {\n          if (err) return reject()\n          resolve()\n        })\n      } )\n    },\n// IDS: all user location IDs\n// Get every FAC with all products in FACs STORE\n    getFac: id => {\n      const sql = `SELECT fl.fac,fl.city,fl.prime,\n      f.open,f.delivery,f.bottleneck,f.mobile,\n      s.product,s.local_promo,s.local_price,\n      s.on_hand,s.take_only,s.add_time\n      FROM fac_location fl\n      JOIN store s ON fl.fac=s.fac AND s.on_hand>0\n      JOIN fac f ON fl.fac=f.id\n      WHERE fl.city=${id} AND fl.prime=1\n      AND f.status=7`\n      return new Promise( (resolve,reject) => {\n        db.query(sql, (err,results) => {\n          if(err) return reject(err)\n          resolve(results)\n        })\n      })\n    }\n\n}\n"]}