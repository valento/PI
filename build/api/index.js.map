{"version":3,"sources":["../../server/api/index.js"],"names":["config","require","options","user","get","password","database","host","socketPath","port","db","mysql","createPool","on","console","log","getOne","data","table","scope","sql","sc","map","entry","_key","Object","keys","_value","values","email","Promise","resolve","reject","query","err","results","getOneReference","l","isNaN","uid","getList","params","PARAMS","length","kk","k","join","concat","saveMany","_keys","v","i","saveOne","_values","push","result","insertId","saveOneLocation","jsn","bg","lat","street_id","city","number","code","updateOne","id","rest","_map"],"mappings":";;;;;;AAAA;;;;AACA;;;;;;;;AACA,IAAMA,SAASC,QAAQ,cAAR,CAAf;;AAEA,IAAMC,UAAU;AACdC,QAAMH,OAAOI,GAAP,CAAW,YAAX,CADQ;AAEdC,YAAUL,OAAOI,GAAP,CAAW,gBAAX,CAFI;AAGdE,YAAUN,OAAOI,GAAP,CAAW,UAAX,CAHI;AAIdG,QAAM;AAJQ,CAAhB;;AAOA,IAAIP,OAAOI,GAAP,CAAW,0BAAX,KAA0CJ,OAAOI,GAAP,CAAW,UAAX,MAA2B,YAAzE,EAAwF;AACtFF,UAAQM,UAAR,kBAAkCR,OAAOI,GAAP,CAAW,0BAAX,CAAlC;AACA;AACAF,UAAQO,IAAR,GAAe,IAAf;AACD;;AAED,IAAMC,KAAKC,gBAAMC,UAAN,CAAiBV,OAAjB,CAAX;AACAQ,GAAGG,EAAH,CAAM,YAAN,EAAoB;AAAA,SAAcC,QAAQC,GAAR,CAAY,cAAZ,CAAd;AAAA,CAApB;;kBAEe;AACbC,UAAQ,kBAA+B;AAAA,QAA9BC,IAA8B,uEAAzB,EAAyB;AAAA,QAAtBC,KAAsB;AAAA,QAAhBC,KAAgB,uEAAV,CAAC,GAAD,CAAU;;AACrC,QAAIC,YAAJ;AACA,QAAIC,KAAKF,MAAMG,GAAN,CAAW;AAAA,aAAS,OAAKC,KAAd;AAAA,KAAX,CAAT;AACA,QAAMC,OAAOC,OAAOC,IAAP,CAAYT,IAAZ,CAAb;AACA,QAAMU,SAASF,OAAOG,MAAP,CAAcX,IAAd,CAAf;AACA,QAAGC,UAAQ,MAAX,EAAkB;AAChBE,wBAAgBC,EAAhB,qNAIiBJ,KAAKY,KAJtB;AAMD,KAPD,MAOO;AACLT,wBAAgBD,KAAhB,cAA8BD,KAA9B,eAA6CM,IAA7C,WAAsDG,MAAtD;AACD;AACHb,YAAQC,GAAR,CAAYK,GAAZ;AACE,WAAO,IAAIU,OAAJ,CAAa,UAACC,OAAD,EAASC,MAAT,EAAoB;AACtCtB,SAAGuB,KAAH,CAASb,GAAT,EAAc,UAACc,GAAD,EAAKC,OAAL,EAAiB;AAC7B,YAAGjB,UAAQ,MAAX,EAAkB;AAACJ,kBAAQC,GAAR,CAAY,kBAAZ,EAA+BoB,OAA/B;AAAwC;AAC3D,YAAG,CAACD,GAAJ,EAAS;AACPH,kBAAQI,OAAR;AACD,SAFD,MAEO;AACLH,iBAAOE,GAAP;AACD;AACF,OAPD;AAQD,KATM,CAAP;AAUD,GA3BY;;AA6Bb;AACAE,mBAAiB,2BAA+B;AAAA,QAA9BnB,IAA8B,uEAAzB,EAAyB;AAAA,QAAtBC,KAAsB;AAAA,QAAhBC,KAAgB,uEAAV,CAAC,GAAD,CAAU;;AAC9C,QAAIC,YAAJ;AAAA,QAASiB,UAAT;AACA,QAAGC,MAAMrB,KAAKsB,GAAX,CAAH,EAAmB;AACjBF,UAAI,OAAJ;AACD,KAFD,MAEO;AACLA,UAAI,MAAJ;AACD;AACDjB,+FAEQiB,CAFR,WAEcpB,KAAKsB,GAFnB;AAIJzB,YAAQC,GAAR,CAAYK,GAAZ;AACI,WAAO,IAAIU,OAAJ,CAAa,UAACC,OAAD,EAASC,MAAT,EAAoB;AACtCtB,SAAGuB,KAAH,CAASb,GAAT,EAAc,UAACc,GAAD,EAAKC,OAAL,EAAiB;AAC7B,YAAG,CAACD,GAAJ,EAAS;AACjBpB,kBAAQC,GAAR,CAAYoB,OAAZ;AACUJ,kBAAQI,OAAR;AACD,SAHD,MAGO;AACLH,iBAAOE,GAAP;AACD;AACF,OAPD;AAQD,KATM,CAAP;AAUD,GApDY;;AAsDbM,WAAS,iBAACtB,KAAD,EAAmC;AAAA,QAA5BC,KAA4B,uEAAtB,CAAC,GAAD,CAAsB;AAAA,QAAhBsB,MAAgB,uEAAT,IAAS;;AAC1C,QAAIC,SAAS,EAAb;AACA,QAAMlB,OAAOiB,SAAQhB,OAAOC,IAAP,CAAYe,MAAZ,CAAR,GAA8B,IAA3C;AACA,QAAGjB,QAAQA,KAAKmB,MAAL,GAAc,CAAzB,EAA4B;AAC1B,UAAMC,KAAKpB,KAAKF,GAAL,CAAU,aAAK;AACxB,eAAUuB,CAAV,SAAeJ,OAAOI,CAAP,CAAf;AACD,OAFU,CAAX;AAGAH,eAAUlB,KAAKmB,MAAL,GAAc,CAAf,GAAmBC,GAAGE,IAAH,CAAQ,OAAR,CAAnB,GAAsCF,GAAG,CAAH,CAA/C;AACA,UAAI1B,UAAU,SAAd,EAA0B;AACxBwB,iBAASA,OAAOK,MAAP,CAAc,gBAAd,CAAT;AACD;AACF;AACD;AACA;AACA;;AAEA,QAAI3B,MAAM,CAACqB,MAAD,eAAmBtB,KAAnB,cAAiCD,KAAjC,eACAC,KADA,cACcD,KADd,eAC6BwB,MADvC;AAEJ5B,YAAQC,GAAR,cAAuBG,KAAvB,SAAiCE,GAAjC;AACI,WAAO,IAAIU,OAAJ,CAAa,UAACC,OAAD,EAASC,MAAT,EAAoB;AACtCtB,SAAGuB,KAAH,CAASb,GAAT,EAAc,UAACc,GAAD,EAAKC,OAAL,EAAiB;AAC7B;AACA,YAAGD,GAAH,EAAQ,OAAOF,OAAOE,GAAP,CAAP;AACRH,gBAAQI,OAAR;AACD,OAJD;AAKD,KANM,CAAP;AAOD,GAhFY;;AAkFba,YAAU,oBAAmB;AAAA,QAAlB/B,IAAkB,uEAAb,EAAa;AAAA,QAAVC,KAAU;;AAC3B,QAAI+B,QAAQxB,OAAOC,IAAP,CAAYT,KAAK,CAAL,CAAZ,CAAZ;AACA,QAAIwB,SAASxB,KAAKK,GAAL,CAAU,aAAK;AAC1B,UAAI4B,IAAIzB,OAAOG,MAAP,CAAcuB,CAAd,CAAR;AACA,aAAOD,CAAP;AACD,KAHY,CAAb;AAIA,QAAM9B,uBAAqBF,KAArB,UAA+B+B,KAA/B,eAAN;AACJnC,YAAQC,GAAR,CAAYK,GAAZ,EAAgB,CAACqB,MAAD,CAAhB;AACI,WAAO,IAAIX,OAAJ,CAAa,UAACC,OAAD,EAASC,MAAT,EAAoB;AACtCtB,SAAGuB,KAAH,CAASb,GAAT,EAAc,CAACqB,MAAD,CAAd,EAAwB,eAAO;AAC7B,YAAIP,GAAJ,EAAS,OAAOF,OAAOE,GAAP,CAAP;AACTH;AACD,OAHD;AAID,KALM,CAAP;AAMD,GAhGY;AAiGbqB,WAAS,mBAAmB;AAAA,QAAlBnC,IAAkB,uEAAb,EAAa;AAAA,QAAVC,KAAU;;AAC1B,QAAI+B,QAAQxB,OAAOC,IAAP,CAAYT,IAAZ,CAAZ;AAAA,QAA+BoC,UAAU,EAAzC;AACA,QAAIZ,SAAShB,OAAOG,MAAP,CAAcX,IAAd,EAAoBK,GAApB,CAAyB,aAAK;AACzC+B,cAAQC,IAAR,CAAa,GAAb;AACA,aAAOJ,CAAP;AACD,KAHY,CAAb;AAIA,QAAM9B,uBAAqBF,KAArB,UAA+B+B,KAA/B,kBAAiDI,OAAjD,MAAN;AACJvC,YAAQC,GAAR,CAAYK,GAAZ,EAAgBqB,MAAhB;AACI,WAAO,IAAIX,OAAJ,CAAa,UAACC,OAAD,EAASC,MAAT,EAAoB;AACtCtB,SAAGuB,KAAH,CAASb,GAAT,EAAcqB,MAAd,EAAsB,UAACP,GAAD,EAAKqB,MAAL,EAAgB;AACpC,YAAIrB,GAAJ,EAAS,OAAOF,OAAOE,GAAP,CAAP;AACTH,gBAAQwB,OAAOC,QAAf;AACD,OAHD;AAID,KALM,CAAP;AAMD,GA/GY;AAgHbC,mBAAiB,2BAAmB;AAAA,QAAlBxC,IAAkB,uEAAb,EAAa;AAAA,QAAVC,KAAU;;AAClC,QAAIwC,MAAI,EAAR;AAAA,QAAWtC,MAAI,EAAf;AADkC,QAE3BuC,EAF2B,GAES1C,IAFT,CAE3B0C,EAF2B;AAAA,QAExBC,GAFwB,GAES3C,IAFT,CAExB2C,GAFwB;AAAA,QAEpBrB,GAFoB,GAEStB,IAFT,CAEpBsB,GAFoB;AAAA,QAEhBsB,SAFgB,GAES5C,IAFT,CAEhB4C,SAFgB;AAAA,QAENC,IAFM,GAES7C,IAFT,CAEN6C,IAFM;AAAA,QAEDC,MAFC,GAES9C,IAFT,CAED8C,MAFC;;;AAIlC,YAAO7C,KAAP;AACE,WAAK,MAAL;AACEwC,6BAAkBC,EAAlB,kBAAiCC,GAAjC,kBAAiDA,GAAjD;AACAxC,+BAAqBF,KAArB,6BAAkDwC,GAAlD,SAAyDzC,KAAK+C,IAA9D;AACF;AACA,WAAK,QAAL;AACEN,6BAAkBC,EAAlB,kBAAiCC,GAAjC,kBAAiDA,GAAjD;AACAxC,+BAAqBF,KAArB,6BAAkDwC,GAAlD,SAAyDzC,KAAK6C,IAA9D;AACF;AACA,WAAK,UAAL;AACAhD,gBAAQC,GAAR,CAAYE,IAAZ;AACEG,+BAAqBF,KAArB,wDACWqB,GADX,WACmBuB,IADnB,SAC2BD,SAD3B,SACwCE,MADxC;AAEF;AAbF;;AAgBFjD,YAAQC,GAAR,CAAYK,GAAZ,EAAgBH,IAAhB;AACE,WAAO,IAAIa,OAAJ,CAAa,UAACC,OAAD,EAASC,MAAT,EAAoB;AACtCtB,SAAGuB,KAAH,CAASb,GAAT,EAAc,eAAO;AACnB,YAAIc,GAAJ,EAAS,OAAOF,QAAP;AACTD;AACD,OAHD;AAID,KALM,CAAP;AAMD,GA3IY;AA4IbkC,aAAW,qBAAmB;AAAA,QAAlBhD,IAAkB,uEAAb,EAAa;AAAA,QAAVC,KAAU;;AAAA,QACrBgD,EADqB,GACNjD,IADM,CACrBiD,EADqB;AAAA,QACdC,IADc,4BACNlD,IADM;;AAE5B,QAAMmD,OAAO3C,OAAOC,IAAP,CAAYyC,IAAZ,EAAkB7C,GAAlB,CAAuB,iBAAS;AAC3C,UAAIC,UAAQ,MAAR,IAAkBA,UAAQ,MAA1B,IAAoCA,UAAQ,OAAhD,EACA;AACE,eAAUA,KAAV,WAAoB4C,KAAK5C,KAAL,CAApB;AACD,OAHD,MAGO;AACL,eAAUA,KAAV,SAAmB4C,KAAK5C,KAAL,CAAnB;AACD;AAEF,KARY,CAAb;AASA,QAAMH,MAAMF,UAAQ,MAAR,eAA0BA,KAA1B,aAAuCkD,IAAvC,mBAAyDF,EAAzD,eACFhD,KADE,aACWkD,IADX,kBAC4BF,EADxC;AAEJpD,YAAQC,GAAR,CAAY,cAAZ,EAA2BK,GAA3B;AACI,WAAO,IAAIU,OAAJ,CAAa,UAACC,OAAD,EAASC,MAAT,EAAoB;AACtCtB,SAAGuB,KAAH,CAASb,GAAT,EAAc,eAAO;AACnB,YAAIc,GAAJ,EAAS,OAAOF,QAAP;AACTD;AACD,OAHD;AAID,KALM,CAAP;AAMD;AAhKY,C","file":"index.js","sourcesContent":["import mysql from 'mysql'\nimport dotenv from 'dotenv'\nconst config = require('../../config')\n\nconst options = {\n  user: config.get('MYSQL_USER'),\n  password: config.get('MYSQL_PASSWORD'),\n  database: config.get('MYSQL_DB'),\n  host: 'localhost'\n}\n\nif( config.get('INSTANCE_CONNECTION_NAME') && config.get('NODE_ENV') === 'production' ) {\n  options.socketPath = `/cloudsql/${config.get('INSTANCE_CONNECTION_NAME')}`\n  //options.host = '172.17.0.6'\n  options.port = 3306\n}\n\nconst db = mysql.createPool(options)\ndb.on('connection', connection => console.log('DB connected'))\n\nexport default {\n  getOne: (data={},table,scope=['*']) => {\n    let sql\n    let sc = scope.map( entry => 'u.'+entry)\n    const _key = Object.keys(data)\n    const _value = Object.values(data)\n    if(table==='user'){\n      sql = `SELECT ${sc},\n      ul.id,ul.name,ul.door,ul.floor,ul.bell,ul.ref,ul.admin,ul.mobile,ul.location,ul.c_status,ul.prime\n      FROM user u\n      LEFT OUTER JOIN user_location ul ON u.uid=ul.uid\n      WHERE u.email='${data.email}'\n      `\n    } else {\n      sql = `SELECT ${scope} FROM ${table} WHERE ${_key}='${_value}'`\n    }\n  console.log(sql)\n    return new Promise( (resolve,reject) => {\n      db.query(sql, (err,results) => {\n        if(table==='user'){console.log('User Init data: ',results)}\n        if(!err) {\n          resolve(results)\n        } else {\n          reject(err)\n        }\n      })\n    })\n  },\n\n  // GET Location by REP = location.uid\n  getOneReference: (data={},table,scope=['*']) => {\n    let sql, l\n    if(isNaN(data.uid)){\n      l = 'l.uid'\n    } else {\n      l = 'l.id'\n    }\n    sql = `SELECT l.number,l.id,s.name\n    FROM location l INNER JOIN street s\n    WHERE ${l}='${data.uid}'\n    AND s.id=l.street_id`\nconsole.log(sql)\n    return new Promise( (resolve,reject) => {\n      db.query(sql, (err,results) => {\n        if(!err) {\nconsole.log(results)\n          resolve(results)\n        } else {\n          reject(err)\n        }\n      })\n    })\n  },\n\n  getList: (table,scope=['*'],params=null) => {\n    let PARAMS = ''\n    const _key = params? Object.keys(params) : null\n    if(_key && _key.length > 0) {\n      const kk = _key.map( k => {\n        return `${k}=${params[k]}`\n      })\n      PARAMS = (_key.length > 1)? kk.join(' AND ') : kk[0]\n      if( table === 'product' ) {\n        PARAMS = PARAMS.concat(' ORDER BY list')\n      }\n    }\n    //else if(_key) {\n    //  PARAMS = `${_key[0]}=${params._key[0]}`\n    //}\n\n    let sql = !params? `SELECT ${scope} FROM ${table}` :\n    `SELECT ${scope} FROM ${table} WHERE ${PARAMS}`\nconsole.log(`Get all ${table}: `,sql)\n    return new Promise( (resolve,reject) => {\n      db.query(sql, (err,results) => {\n        //console.log(results)\n        if(err) return reject(err)\n        resolve(results)\n      })\n    })\n  },\n\n  saveMany: (data=[],table) => {\n    let _keys = Object.keys(data[0])\n    let params = data.map( i => {\n      let v = Object.values(i)\n      return v\n    })\n    const sql = `INSERT INTO ${table} (${_keys}) VALUES ?`\nconsole.log(sql,[params])\n    return new Promise( (resolve,reject) => {\n      db.query(sql, [params], err => {\n        if (err) return reject(err)\n        resolve()\n      })\n    })\n  },\n  saveOne: (data={},table) => {\n    let _keys = Object.keys(data), _values = []\n    let params = Object.values(data).map( v => {\n      _values.push('?')\n      return v\n    })\n    const sql = `INSERT INTO ${table} (${_keys}) VALUES (${_values})`\nconsole.log(sql,params)\n    return new Promise( (resolve,reject) => {\n      db.query(sql, params, (err,result) => {\n        if (err) return reject(err)\n        resolve(result.insertId)\n      })\n    })\n  },\n  saveOneLocation: (data={},table) => {\n    let jsn='',sql=''\n    const {bg,lat,uid,street_id,city,number} = data\n\n    switch(table) {\n      case 'city':\n        jsn = `'{\"bg\": \"${bg}\", \"en\": \"${lat}\", \"es\": \"${lat}\"}'`\n        sql = `INSERT INTO ${table} (name,code) VALUES (${jsn},${data.code})`\n      break\n      case 'street':\n        jsn = `'{\"bg\": \"${bg}\", \"en\": \"${lat}\", \"es\": \"${lat}\"}'`\n        sql = `INSERT INTO ${table} (name,city) VALUES (${jsn},${data.city})`\n      break\n      case 'location':\n      console.log(data)\n        sql = `INSERT INTO ${table} (uid,city,street_id,number)\n        VALUES ('${uid}',${city},${street_id},${number})`\n      break\n    }\n\n  console.log(sql,data)\n    return new Promise( (resolve,reject) => {\n      db.query(sql, err => {\n        if (err) return reject()\n        resolve()\n      })\n    })\n  },\n  updateOne: (data={},table) => {\n    const {id, ...rest} = data\n    const _map = Object.keys(rest).map( entry => {\n      if (entry==='name' || entry==='bell' || entry==='entry')\n      {\n        return `${entry}='${rest[entry]}'`\n      } else {\n        return `${entry}=${rest[entry]}`\n      }\n\n    })\n    const sql = table==='user'? `UPDATE ${table} SET ${_map} WHERE uid=${id}` :\n    `UPDATE ${table} SET ${_map} WHERE id=${id}`\nconsole.log('Update ORM: ',sql)\n    return new Promise( (resolve,reject) => {\n      db.query(sql, err => {\n        if (err) return reject()\n        resolve()\n      })\n    } )\n  }\n}\n"]}