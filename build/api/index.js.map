{"version":3,"sources":["../../server/api/index.js"],"names":["config","require","options","user","get","password","database","socketPath","host","db","mysql","createConnection","connect","console","log","err","getOne","data","table","scope","sql","sc","map","entry","_key","Object","keys","_value","values","email","Promise","resolve","reject","query","results","getOneReference","l","isNaN","uid","getList","params","PARAMS","length","kk","k","join","concat","saveOne","_keys","_values","push","v","result","insertId","saveOneLocation","jsn","bg","lat","code","city","street_id","number","updateOne","id","rest","_map"],"mappings":"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","file":"index.js","sourcesContent":["import mysql from 'mysql'\nimport dotenv from 'dotenv'\nconst config = require('../../config')\n\nconst options = {\n  user: config.get('MYSQL_USER'),\n  password: config.get('MYSQL_PASSWORD'),\n  database: config.get('MYSQL_DB')\n}\n\nif( config.get('INSTANCE_CONNECTION_NAME') && config.get('NODE_ENV') === 'production' ) {\n  options.socketPath = `/cloudsql/${config.get('INSTANCE_CONNECTION_NAME')}`\n} else {\n  options.host = 'localhost'\n}\n\nconst db = mysql.createConnection(options)\ndb.connect( err => console.log(err) )\nexport default {\n  getOne: (data={},table,scope=['*']) => {\n    let sql\n    let sc = scope.map( entry => 'u.'+entry)\n    const _key = Object.keys(data)\n    const _value = Object.values(data)\n    if(table==='user'){\n      sql = `SELECT ${sc},\n      ul.id,ul.name,ul.door,ul.floor,ul.bell,ul.ref,ul.admin,ul.mobile,ul.location,ul.c_status,ul.prime\n      FROM user u\n      LEFT OUTER JOIN user_location ul ON u.uid=ul.uid\n      WHERE u.email='${data.email}'\n      `\n    } else {\n      sql = `SELECT ${scope} FROM ${table} WHERE ${_key}='${_value}'`\n    }\n  console.log(sql)\n    return new Promise( (resolve,reject) => {\n      db.query(sql, (err,results) => {\n        if(table==='user'){console.log('User Init data: ',results)}\n        if(!err) {\n          resolve(results)\n        } else {\n          reject(err)\n        }\n      })\n    })\n  },\n  // GET Location by REP = location.uid\n  getOneReference: (data={},table,scope=['*']) => {\n    let sql, l\n    if(isNaN(data.uid)){\n      l = 'l.uid'\n    } else {\n      l = 'l.id'\n    }\n    sql = `SELECT l.number,l.id,s.name\n    FROM location l INNER JOIN street s\n    WHERE ${l}='${data.uid}'\n    AND s.id=l.street_id`\nconsole.log(sql)\n    return new Promise( (resolve,reject) => {\n      db.query(sql, (err,results) => {\n        if(!err) {\nconsole.log(results)\n          resolve(results)\n        } else {\n          reject(err)\n        }\n      })\n    })\n  },\n  getList: (table,scope=['*'],params=null) => {\n    let PARAMS = ''\n    const _key = params? Object.keys(params) : null\n    if(_key && _key.length > 0) {\n      const kk = _key.map( k => {\n        return `${k}=${params[k]}`\n      })\n      PARAMS = (_key.length > 1)? kk.join(' AND ') : kk[0]\n      if( table === 'product' ) {\n        PARAMS = PARAMS.concat(' ORDER BY list')\n      }\n    }\n    //else if(_key) {\n    //  PARAMS = `${_key[0]}=${params._key[0]}`\n    //}\n\n    let sql = !params? `SELECT ${scope} FROM ${table}`:`SELECT ${scope} FROM ${table} WHERE ${PARAMS}`\n\n    return new Promise( (resolve,reject) => {\n      db.query(sql, params, (err,results) => {\n        console.log('getList Error: ',err)\n        if(err) {\n\n          return reject(err)\n        }\n        resolve(results)\n      })\n    })\n  },\n  saveOne: (data={},table) => {\n    let _keys = Object.keys(data), _values = []\n    let params = Object.values(data).map( v => {\n      _values.push('?')\n      return v\n    })\n    const sql = `INSERT INTO ${table} (${_keys}) VALUES (${_values})`\nconsole.log(sql,params)\n    return new Promise( (resolve,reject) => {\n      db.query(sql, params, (err,result) => {\n        if (err) return reject()\n        resolve(result.insertId)\n      })\n    })\n  },\n  saveOneLocation: (data={},table) => {\n    let jsn='',sql=''\n    const {bg,lat} = data\n    switch(table) {\n      case 'city':\n        jsn = `'{\"bg\": \"${bg}\", \"en\": \"${lat}\", \"es\": \"${lat}\"}'`\n        sql = `INSERT INTO ${table} (name,code) VALUES (${jsn},${data.code})`\n      break\n      case 'street':\n        jsn = `'{\"bg\": \"${bg}\", \"en\": \"${lat}\", \"es\": \"${lat}\"}'`\n        sql = `INSERT INTO ${table} (name,city) VALUES (${jsn},${data.city})`\n      break\n      case 'location':\n        sql = `INSERT INTO ${table} (uid,city,street_id,number) VALUES ('${data.uid}',${data.city},${data.street_id},${data.number})`\n      break\n    }\n\n  console.log(sql)\n    return new Promise( (resolve,reject) => {\n      db.query(sql, err => {\n        if (err) return reject()\n        resolve()\n      })\n    })\n  },\n  updateOne: (data={},table) => {\n    const {id, ...rest} = data\n    const _map = Object.keys(rest).map( entry => {\n      if (entry==='name' || entry==='bell' || entry==='entry')\n      {\n        return `${entry}='${rest[entry]}'`\n      } else {\n        return `${entry}=${rest[entry]}`\n      }\n\n    })\n    const sql =`UPDATE ${table} SET ${_map} WHERE id=${id}`\nconsole.log('ORM: ',sql)\n    return new Promise( (resolve,reject) => {\n      db.query(sql, err => {\n        if (err) return reject()\n        resolve()\n      })\n    } )\n  }\n}\n"]}