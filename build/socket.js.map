{"version":3,"sources":["../server/socket.js"],"names":["WS","require","server","WSR","router","conn","root","lab","fac","baker","pos","dlv","test","rep","customer","roles","open","member","rnd","Math","floor","random","console","log","wsServer","httpServer","autoAcceptConnections","wsrouter","attachServer","forEach","role","index","mount","request","on","connection","protocol","length","c","send","JSON","stringify","customer_counter","b","map","cst","FAC","accept","origin","resourceURL","query","id","ID","Number","con","find","push","parse","msg","utf8Data","user","mem","ordered","bkr","order","undefined","filter","reasonCode","description","i","splice","Date","reason","dsc","Object","assign"],"mappings":"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","file":"socket.js","sourcesContent":["// Initiate WEB SOCKET:\r\n  var WS = require('websocket').server\r\n  var WSR = require('websocket').router\r\n\r\n// WS Connection Objects List: user,ref,dlv,pos,baker,fac,lab,root\r\n  let conn = { root: [], lab: [], fac: [], baker: [], pos: [], dlv: [],\r\n    test: [], rep: [], customer: [] }\r\n// WS protocols:\r\n  var roles = ['root','lab','fac','baker','pos','dlv','test','rep','customer']\r\n\r\n\r\n\r\nconst open = (server,member) => {\r\n  let rnd = Math.floor(Math.random()*Math.floor(6))\r\nconsole.log('Initial Users: ',rnd)\r\n  const wsServer = new WS({\r\n    httpServer: server,\r\n    autoAcceptConnections: false\r\n  })\r\n\r\n  const wsrouter = new WSR()\r\n  wsrouter.attachServer(wsServer)\r\n\r\n  roles.forEach( (role,index) => {\r\n    wsrouter.mount('*',`${role}-protocol`, request => {\r\n// Count Inital User array on Hand-shake:\r\n      request.on('requestAccepted', connection => {\r\n        if(connection.protocol === 'customer-protocol') {\r\n          if(conn.customer.length > 0) {\r\n             conn.customer.forEach( c => c.send(JSON.stringify({\r\n               customer_counter: conn.customer.length+rnd\r\n             })))\r\n          }\r\n          if(conn.baker.length > 0) {\r\n            conn.baker.forEach( b => b.send(JSON.stringify({\r\n              customer_counter: conn.customer.map(cst => cst.FAC)\r\n            })))\r\n          }\r\n        } else if (connection.protocol === 'baker-protocol'){\r\n          if(conn.baker.length>0) {\r\n            conn.baker.forEach( b => b.send(JSON.stringify({\r\n              customer_counter: conn.customer.map(cst => cst.FAC)\r\n            })))\r\n          }\r\n        }\r\n      })\r\n  // get WS.Connection\r\n      let connection = request.accept(request.origin)\r\n      const { id,fac } = request.resourceURL.query\r\n      connection.ID = Number(id)\r\n      connection.FAC = Number(fac)\r\n  // Store baker-Connections:\r\n      let con = conn[role].find( c => c.ID === Number(id) )\r\n      if( !con ) conn[role].push(connection)\r\n\r\n  // Event handlers:\r\n  // ------ MESSAGING Event: ------------------------------------\r\n      connection.on('message', msg => {\r\n        const { user,fac,mem,ordered,open } = JSON.parse(msg.utf8Data)\r\n        console.log('Socket Parse: ', user,fac,mem,ordered)\r\n        let bkr = conn.baker.find( c => c.ID === fac )\r\n        let order = !!ordered\r\n        if(bkr && order) {\r\n          bkr.send(JSON.stringify({ user: id, order: order }))\r\n        } else if(open !== undefined) {\r\n          conn.customer.filter( c => c.FAC===fac )\r\n          .forEach( c => c.send(JSON.stringify({ fac:fac, open:open })) )\r\n        }\r\n      //conn[roles[Math.log2(mem)]].find( c => c.ID===user ).sendUTF(`Message from User: ${user}, recieved`)\r\n\r\n      //connection.sendUTF(`Message from Baker: ${user}, recieved`)\r\n      })\r\n  // ------ CLOSE Event: ------------------------------------\r\n      connection.on('close', (reasonCode, description) => {\r\n        let i = conn[role].find(c => c.ID === connection.ID)\r\n        conn[role].splice(i,1)\r\n        if(role === 'customer' && conn.customer.length>0) {\r\n          conn.customer.forEach( c => {\r\n            if(conn.customer.length > 0) {\r\n               conn.customer.forEach( c => c.send(JSON.stringify({\r\n                 customer_counter: conn.customer.length+rnd\r\n               })))\r\n            }\r\n            if(conn.baker.length > 0) {\r\n              conn.baker.forEach( b => {\r\n                b.send(JSON.stringify({\r\n                  customer_counter: conn.customer.map(cst => cst.FAC)\r\n                }))\r\n              })\r\n            }\r\n          })\r\n        }\r\n      })\r\n\r\n    })\r\n  })\r\n\r\n  wsServer.on('connect', socket => {\r\n    console.log('Connection created at: ', new Date())\r\n  })\r\n\r\n  wsServer.on('close', (conn, reason, dsc) => {\r\n    console.log('Connection closed at: ', conn.ID)\r\n  })\r\n\r\n// BAKER: =====================================================================\r\n\r\n\r\n//// CUSTOMER: ==================================================================\r\n//  wsrouter.mount('*','customer-protocol', request => {\r\n//    request.on('requestAccepted', connection => {\r\n//      connection.sendUTF('WS: Customer accepted!')\r\n//    })\r\n//// get WS.Connection:\r\n//    let connection = request.accept(request.origin)\r\n//    const { id } = request.resourceURL.query\r\n//    connection.ID = Number(id)\r\n//\r\n//// Event handlers:\r\n//// ------ MESSAGING Event: ----------------------\r\n//    connection.on('message', msg => {\r\n//      const { user,fac,role,order } = JSON.parse(msg.utf8Data)\r\n//      console.log('Message from customer:', connection.ID)\r\n//      if(order) {\r\n//      // ping 'baker-protocol'\r\n//        let bkr = bconn.find( c => c.ID === fac )\r\n//        if(bkr) bkr.send(JSON.stringify({ user: id, order: true }))\r\n//      }\r\n//      uconn.forEach( c => {\r\n//        c.sendUTF(`One more Customer: ${user}, recieved`)\r\n//      })\r\n//      //connection.sendUTF(`${uconn.length - 1} Messages from User: ${user}, send`)\r\n//\r\n//    })\r\n//// ------ CLOSE Event: ------------------------------------\r\n//    connection.on('close', (reasonCode, description) => {\r\n//      let c = uconn.indexOf(connection)\r\n//      //if(uconn[c].ID) connection.sendUTF('WS: Customer connection closed!', uconn[c].ID)\r\n//      uconn.splice(c,1)\r\n//      console.log('Consumer Sockets: ',uconn.length)\r\n//    })\r\n//\r\n//// Store unique customer-connections:\r\n//    let user = uconn.find( c => c.ID === Number(id) )\r\n//    if( !user ) uconn.push(connection)\r\n//\r\n//  })\r\n//\r\n//// TESTER: =====================================================================\r\n//    wsrouter.mount('*','test-protocol', request => {\r\n//      request.on('requestAccepted', connection => {\r\n//        connection.sendUTF('WS: Tester is listening!')\r\n//      })\r\n//  // get WS.Connection\r\n//      let connection = request.accept(request.origin)\r\n//      const { id } = request.resourceURL.query\r\n//\r\n//  // Event handlers:\r\n//      connection.ID = Number(id)\r\n//      connection.on('message', msg => {\r\n//        const { user,fac,role } = JSON.parse(msg.utf8Data)\r\n//        console.log('WS: Connected Testers: ', tconn.length)\r\n//      // bconn.find( c => c.id===fac.id ).sendUTF(`Message from User: ${user}, recieved`)\r\n//        //connection.sendUTF(`Message from Baker: ${user}, recieved`)\r\n//      })\r\n//  // Store baker-Connections:\r\n//      let tester = tconn.find( c => c.ID === Number(id) )\r\n//      if( !tester ) tconn.push(connection)\r\n//    })\r\n//// ======================================================================\r\n//\r\n//  // WebSocketServer Class:\r\n//  //wsServer.on('request', request => {\r\n//  //// request is webSocketRequest Object\r\n//  //// .accept returns webSocketConnection Instance\r\n//  //  let bakerCon = request.accept('baker-protocol', request.origin)\r\n//  //\r\n//  //})\r\n//\r\n\r\n\r\n}\r\n\r\nexport default Object.assign({},{ open })\r\n"]}